<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rama SDA Junior School - Exam Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; }
        }
        .print-only { display: none; }
        
        .logo-container {
            width: 80px;
            height: 80px;
            background-image: url('https://pfst.cf2.poecdn.net/base/image/9a8fd71dbc71963ef1fbe99d7e8a89a413f1c9bda60d46cd35773a3c85b38c7a?w=1024&h=1536');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .small-logo {
            width: 40px;
            height: 40px;
        }

        .grade-ee { background-color: #dcfce7; color: #166534; }
        .grade-me { background-color: #dbeafe; color: #1e40af; }
        .grade-ae { background-color: #fef3c7; color: #92400e; }
        .grade-be { background-color: #fee2e2; color: #dc2626; }
        
        .champion-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #92400e;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#1e3a8a'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md">
            <div class="text-center mb-6">
                <div class="logo-container mx-auto mb-4"></div>
                <h1 class="text-2xl font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                <p class="text-sm text-gray-600 dark:text-gray-400">Exam Management System</p>
                <p class="text-xs text-gray-500 mt-2">P.O. BOX 45-50201, CHEPTAIS</p>
                <p class="text-xs italic text-primary font-semibold">"IN GOD WE CAN"</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" id="username" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter password">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Role</label>
                    <select id="userRole" class="w-full p-3 border rounded-lg text-base">
                        <option value="admin">Admin</option>
                        <option value="teacher">Teacher</option>
                        <option value="parent">Parent</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-primary text-white p-3 rounded-lg hover:bg-opacity-90 transition font-semibold">
                    üîê Login
                </button>
                <div class="text-xs text-gray-500 text-center mt-4">
                    <p>Demo Credentials:</p>
                    <p>Password: <strong>123456</strong> or <strong>admin123</strong> (for admin)</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b sticky top-0 z-50">
            <div class="flex items-center justify-between p-4">
                <div class="flex items-center space-x-4">
                    <div class="logo-container small-logo"></div>
                    <div>
                        <h1 class="text-lg font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                        <p class="text-xs text-gray-600 dark:text-gray-400">Exam Management System ‚Ä¢ "IN GOD WE CAN"</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <span id="currentUser" class="text-sm font-medium block"></span>
                        <span id="currentTime" class="text-xs text-gray-500"></span>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="navigation" class="bg-secondary text-white p-4 shadow-md">
            <div class="flex flex-wrap gap-2" id="navButtons"></div>
        </nav>

        <!-- Content Area -->
        <main class="p-4 md:p-6 min-h-screen">
            <div id="contentArea"></div>
        </main>
    </div>

    <script>
        // Initialize dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Update time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);

        // Data Storage with Enhanced Structure
        let appData = {
            students: [],
            teachers: [],
            marks: [],
            announcements: [],
            settings: {
                currentYear: new Date().getFullYear(),
                terms: [
                    { name: 'Term 1', midterm: 'Term 1 Midterm', endterm: 'Term 1 Endterm' },
                    { name: 'Term 2', midterm: 'Term 2 Midterm', endterm: 'Term 2 Endterm' },
                    { name: 'Term 3', midterm: 'Term 3 Midterm', endterm: 'Term 3 Endterm' }
                ],
                examTypes: ['Midterm', 'Endterm'],
                grades: ['7', '8', '9'],
                subjects: [
                    { name: 'ENGLISH', code: 'ENG' },
                    { name: 'KISWAHILI', code: 'KIS' },
                    { name: 'MATHEMATICS', code: 'MAT' },
                    { name: 'INTEGRATED SCIENCE', code: 'ISC' },
                    { name: 'AGRICULTURE AND NUTRITION', code: 'AGR' },
                    { name: 'SOCIAL STUDIES', code: 'SOC' },
                    { name: 'PRE-TECHNICAL STUDIES', code: 'PTS' },
                    { name: 'CHRISTIAN RELIGIOUS EDUCATION', code: 'CRE' },
                    { name: 'CREATIVE ARTS AND SPORTS', code: 'CAS' }
                ],
                termDates: {
                    term1: { opening: '', closing: '' },
                    term2: { opening: '', closing: '' },
                    term3: { opening: '', closing: '' }
                }
            }
        };

        let currentUser = null;

        // Enhanced Utility Functions
        function generateAssessmentNumber() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const letter = letters[Math.floor(Math.random() * letters.length)];
            const numbers = Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
            return letter + numbers;
        }

        function generateAdmissionNumber() {
            const existing = appData.students.map(s => parseInt(s.admissionNumber));
            const max = existing.length > 0 ? Math.max(...existing) : 0;
            return (max + 1).toString().padStart(4, '0');
        }

        function calculateGrade(mark) {
            if (mark >= 88) return { pl: 'EE', al: 'AL8', points: 8, class: 'grade-ee' };
            if (mark >= 75) return { pl: 'EE', al: 'AL7', points: 7, class: 'grade-ee' };
            if (mark >= 62) return { pl: 'ME', al: 'AL6', points: 6, class: 'grade-me' };
            if (mark >= 50) return { pl: 'ME', al: 'AL5', points: 5, class: 'grade-me' };
            if (mark >= 37) return { pl: 'AE', al: 'AL4', points: 4, class: 'grade-ae' };
            if (mark >= 25) return { pl: 'AE', al: 'AL3', points: 3, class: 'grade-ae' };
            if (mark >= 12) return { pl: 'BE', al: 'AL2', points: 2, class: 'grade-be' };
            return { pl: 'BE', al: 'AL1', points: 1, class: 'grade-be' };
        }

        function getTeacherInitials(teacherName) {
            return teacherName.split(' ').map(name => name[0].toUpperCase()).join('.');
        }

        function getPerformanceLevelFull(pl) {
            const levels = {
                'EE': 'EXCEEDING EXPECTATIONS',
                'ME': 'MEETING EXPECTATIONS',
                'AE': 'APPROACHING EXPECTATIONS',
                'BE': 'BELOW EXPECTATIONS'
            };
            return levels[pl] || '';
        }

        // Save data to localStorage (when available)
        function saveData() {
            try {
                localStorage.setItem('ramaSchoolData', JSON.stringify(appData));
            } catch (e) {
                console.log('LocalStorage not available, data saved in memory only');
            }
        }

        // Load data from localStorage (when available)
        function loadData() {
            try {
                const savedData = localStorage.getItem('ramaSchoolData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                }
            } catch (e) {
                console.log('LocalStorage not available, using default data');
            }
        }

        // Login System
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('userRole').value;

            // Enhanced authentication
            if (password === '123456' || (role === 'admin' && password === 'admin123')) {
                currentUser = { username, role, loginTime: new Date() };
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `${username} (${role.toUpperCase()})`;
                updateTime();
                loadData();
                initializeNavigation();
                showDashboard();
            } else {
                alert('‚ùå Invalid credentials!\n\nUse:\n‚Ä¢ Password: 123456 (all users)\n‚Ä¢ Password: admin123 (admin only)');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                saveData();
                currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainDashboard').classList.add('hidden');
                document.getElementById('loginForm').reset();
            }
        });

        // Enhanced Navigation System
        function initializeNavigation() {
            const navButtons = document.getElementById('navButtons');
            navButtons.innerHTML = '';

            const allMenus = {
                admin: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä', color: 'bg-blue-600' },
                    { id: 'students', label: 'Students', icon: 'üë•', color: 'bg-green-600' },
                    { id: 'teachers', label: 'Teachers', icon: 'üë®‚Äçüè´', color: 'bg-purple-600' },
                    { id: 'marks', label: 'Marks Entry', icon: 'üìù', color: 'bg-orange-600' },
                    { id: 'reports', label: 'Reports', icon: 'üìÑ', color: 'bg-red-600' },
                    { id: 'analysis', label: 'Analysis', icon: 'üìà', color: 'bg-indigo-600' },
                    { id: 'announcements', label: 'Announcements', icon: 'üì¢', color: 'bg-yellow-600' },
                    { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è', color: 'bg-gray-600' }
                ],
                teacher: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä', color: 'bg-blue-600' },
                    { id: 'marks', label: 'Enter Marks', icon: 'üìù', color: 'bg-orange-600' },
                    { id: 'reports', label: 'View Reports', icon: 'üìÑ', color: 'bg-red-600' },
                    { id: 'analysis', label: 'Analysis', icon: 'üìà', color: 'bg-indigo-600' },
                    { id: 'announcements', label: 'Announcements', icon: 'üì¢', color: 'bg-yellow-600' }
                ],
                parent: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä', color: 'bg-blue-600' },
                    { id: 'results', label: 'View Results', icon: 'üìÑ', color: 'bg-green-600' },
                    { id: 'announcements', label: 'Announcements', icon: 'üì¢', color: 'bg-yellow-600' }
                ]
            };

            const menus = allMenus[currentUser.role] || [];
            
            menus.forEach(menu => {
                const button = document.createElement('button');
                button.className = `${menu.color} hover:opacity-90 px-4 py-2 rounded-lg transition flex items-center space-x-2 text-white font-medium`;
                button.innerHTML = `<span>${menu.icon}</span><span>${menu.label}</span>`;
                button.onclick = () => showSection(menu.id);
                navButtons.appendChild(button);
            });
        }

        // Section Display Functions
        function showSection(sectionId) {
            switch(sectionId) {
                case 'dashboard': showDashboard(); break;
                case 'students': showStudentManagement(); break;
                case 'teachers': showTeacherManagement(); break;
                case 'marks': showMarksEntry(); break;
                case 'reports': showReports(); break;
                case 'analysis': showAnalysis(); break;
                case 'announcements': showAnnouncements(); break;
                case 'settings': showSettings(); break;
                case 'results': showParentResults(); break;
            }
        }

        function showDashboard() {
            const contentArea = document.getElementById('contentArea');
            
            // Calculate statistics
            const totalStudents = appData.students.length;
            const totalTeachers = appData.teachers.length;
            const totalMarks = appData.marks.length;
            const totalAnnouncements = appData.announcements.length;
            
            const currentYear = appData.settings.currentYear;
            const currentYearMarks = appData.marks.filter(m => m.year == currentYear);
            
            // Grade distribution
            const gradeDistribution = {};
            appData.settings.grades.forEach(grade => {
                gradeDistribution[grade] = appData.students.filter(s => s.grade === grade).length;
            });

            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Welcome Banner -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Welcome to Rama SDA Junior School</h2>
                                <p class="text-blue-100">Comprehensive Exam Management System ‚Ä¢ Academic Year ${currentYear}</p>
                                <p class="text-blue-200 text-sm mt-1">"IN GOD WE CAN" - Building Excellence in Education</p>
                            </div>
                            <div class="logo-container opacity-80"></div>
                        </div>
                    </div>

                    <!-- Key Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-600">Total Students</h3>
                                    <p class="text-3xl font-bold">${totalStudents}</p>
                                    <p class="text-sm text-gray-500">Registered learners</p>
                                </div>
                                <div class="text-4xl text-blue-500">üë•</div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-green-600">Total Teachers</h3>
                                    <p class="text-3xl font-bold">${totalTeachers}</p>
                                    <p class="text-sm text-gray-500">Teaching staff</p>
                                </div>
                                <div class="text-4xl text-green-500">üë®‚Äçüè´</div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-purple-600">Marks Entries</h3>
                                    <p class="text-3xl font-bold">${totalMarks}</p>
                                    <p class="text-sm text-gray-500">Assessment records</p>
                                </div>
                                <div class="text-4xl text-purple-500">üìù</div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-orange-600">Announcements</h3>
                                    <p class="text-3xl font-bold">${totalAnnouncements}</p>
                                    <p class="text-sm text-gray-500">Active notices</p>
                                </div>
                                <div class="text-4xl text-orange-500">üì¢</div>
                            </div>
                        </div>
                    </div>

                    <!-- School Information & Grade Distribution -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-primary">üìö School Information</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Curriculum</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">CBC (Competency Based)</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Grades</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">7, 8, and 9</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Learning Areas</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${appData.settings.subjects.length} subjects</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Assessment</h4>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Formative & Summative</p>
                                    </div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded border border-blue-200 dark:border-blue-700">
                                    <h4 class="font-semibold text-blue-700 dark:text-blue-300">Contact Information</h4>
                                    <p class="text-sm text-blue-600 dark:text-blue-400">üìß P.O. BOX 45-50201, CHEPTAIS</p>
                                    <p class="text-sm text-blue-600 dark:text-blue-400">üéØ "IN GOD WE CAN"</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-primary">üìä Grade Distribution</h3>
                            <div class="space-y-3">
                                ${appData.settings.grades.map(grade => {
                                    const count = gradeDistribution[grade];
                                    const percentage = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0;
                                    return `
                                        <div class="flex items-center justify-between">
                                            <span class="font-medium">Grade ${grade}</span>
                                            <div class="flex items-center space-x-2">
                                                <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                                    <div class="bg-primary h-2 rounded-full" style="width: ${percentage}%"></div>
                                                </div>
                                                <span class="text-sm font-semibold w-12">${count}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            ${currentUser.role === 'admin' ? `
                                <div class="mt-4 pt-4 border-t dark:border-gray-600">
                                    <h4 class="font-semibold mb-2">Quick Actions</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="showSection('students')" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                            ‚ûï Add Student
                                        </button>
                                        <button onclick="showSection('teachers')" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700">
                                            ‚ûï Add Teacher
                                        </button>
                                        <button onclick="showSection('marks')" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                                            üìù Enter Marks
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Recent Activity & Quick Links -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-primary">üì¢ Recent Announcements</h3>
                            <div class="space-y-3 max-h-60 overflow-y-auto">
                                ${appData.announcements.length === 0 ? 
                                    '<p class="text-gray-500 dark:text-gray-400 text-center py-4">No announcements yet</p>' :
                                    appData.announcements.slice(0, 3).map(announcement => `
                                        <div class="border dark:border-gray-600 p-3 rounded-lg">
                                            <h4 class="font-semibold text-sm">${announcement.title}</h4>
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${announcement.message.substring(0, 100)}${announcement.message.length > 100 ? '...' : ''}</p>
                                            <div class="flex justify-between items-center mt-2">
                                                <span class="text-xs text-primary">${announcement.audience}</span>
                                                <span class="text-xs text-gray-500">${new Date(announcement.date).toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            ${appData.announcements.length > 3 ? `
                                <div class="mt-3 text-center">
                                    <button onclick="showSection('announcements')" class="text-primary text-sm hover:underline">
                                        View all announcements ‚Üí
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4 text-primary">üéØ Learning Areas</h3>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${appData.settings.subjects.map(subject => `
                                    <div class="bg-gray-50 dark:bg-gray-700 p-2 rounded flex items-center justify-between">
                                        <span class="truncate">${subject.name}</span>
                                        <span class="text-primary font-mono">${subject.code}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showStudentManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üë• Student Management</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total: ${appData.students.length} students</span>
                            </div>
                        </div>
                        
                        <!-- Add Student Form -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 text-green-600">‚ûï Register New Student</h3>
                                <form id="studentForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
                                        <input type="text" id="studentName" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter student's full name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Gender <span class="text-red-500">*</span></label>
                                        <select id="studentGender" class="w-full p-3 border rounded-lg text-base" required>
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Grade/Class <span class="text-red-500">*</span></label>
                                        <select id="studentGrade" class="w-full p-3 border rounded-lg text-base" required>
                                            <option value="">Select Grade</option>
                                            ${appData.settings.grades.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('')}
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                        üìù Register Student
                                    </button>
                                </form>
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 text-blue-600">üìä Student Statistics</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>Total Students:</span>
                                        <span class="font-bold text-lg text-primary">${appData.students.length}</span>
                                    </div>
                                    ${appData.settings.grades.map(grade => {
                                        const count = appData.students.filter(s => s.grade === grade).length;
                                        const percentage = appData.students.length > 0 ? ((count / appData.students.length) * 100).toFixed(1) : 0;
                                        return `
                                            <div class="flex justify-between items-center">
                                                <span>Grade ${grade}:</span>
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-semibold">${count}</span>
                                                    <span class="text-sm text-gray-500">(${percentage}%)</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                    
                                    <div class="pt-3 border-t dark:border-gray-600">
                                        <div class="flex justify-between items-center">
                                            <span>Male Students:</span>
                                            <span class="font-semibold">${appData.students.filter(s => s.gender === 'Male').length}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span>Female Students:</span>
                                            <span class="font-semibold">${appData.students.filter(s => s.gender === 'Female').length}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Student List -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">üìã Registered Students</h3>
                            <div class="flex space-x-2">
                                <button onclick="exportStudents()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                    üì• Export
                                </button>
                                <select id="gradeFilter" class="p-2 border rounded text-sm" onchange="filterStudents()">
                                    <option value="">All Grades</option>
                                    ${appData.settings.grades.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">S/No</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">ADM NO</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Assessment No</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Name</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Gender</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Grade</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Date Registered</th>
                                        ${currentUser.role === 'admin' ? '<th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    ${appData.students.length === 0 ? 
                                        `<tr><td colspan="${currentUser.role === 'admin' ? '8' : '7'}" class="border border-gray-300 dark:border-gray-600 p-8 text-center text-gray-500">No students registered yet</td></tr>` :
                                        appData.students.map((student, index) => `
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">${index + 1}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.admissionNumber}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.assessmentNumber}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${student.name}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                    <span class="px-2 py-1 rounded text-xs ${student.gender === 'Male' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'}">
                                                        ${student.gender}
                                                    </span>
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                    <span class="px-2 py-1 bg-primary text-white rounded text-sm">Grade ${student.grade}</span>
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-sm text-gray-600 dark:text-gray-400">
                                                    ${new Date(student.dateRegistered).toLocaleDateString()}
                                                </td>
                                                ${currentUser.role === 'admin' ? `
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                        <div class="flex space-x-1">
                                                            <button onclick="editStudent('${student.assessmentNumber}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                                                ‚úèÔ∏è Edit
                                                            </button>
                                                            <button onclick="deleteStudent('${student.assessmentNumber}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                                üóëÔ∏è Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `).join('')
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Add event listener for student form
            document.getElementById('studentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('studentName').value.trim();
                const gender = document.getElementById('studentGender').value;
                const grade = document.getElementById('studentGrade').value;

                if (!name || !gender || !grade) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const student = {
                    admissionNumber: generateAdmissionNumber(),
                    assessmentNumber: generateAssessmentNumber(),
                    name,
                    gender,
                    grade,
                    dateRegistered: new Date().toISOString()
                };

                appData.students.push(student);
                saveData();
                alert(`‚úÖ Student registered successfully!\n\nAdmission No: ${student.admissionNumber}\nAssessment No: ${student.assessmentNumber}`);
                showStudentManagement(); // Refresh the view
            });
        }

        function editStudent(assessmentNumber) {
            const student = appData.students.find(s => s.assessmentNumber === assessmentNumber);
            if (!student) return;

            const newName = prompt('Enter new name:', student.name);
            if (!newName) return;

            const newGender = prompt('Enter new gender (Male/Female):', student.gender);
            if (!newGender || !['Male', 'Female'].includes(newGender)) {
                alert('Please enter a valid gender (Male or Female)');
                return;
            }

            const newGrade = prompt('Enter new grade (7/8/9):', student.grade);
            if (!newGrade || !appData.settings.grades.includes(newGrade)) {
                alert('Please enter a valid grade (7, 8, or 9)');
                return;
            }

            student.name = newName.trim();
            student.gender = newGender;
            student.grade = newGrade;
            saveData();
            showStudentManagement(); // Refresh the view
            alert('‚úÖ Student updated successfully!');
        }

        function deleteStudent(assessmentNumber) {
            const student = appData.students.find(s => s.assessmentNumber === assessmentNumber);
            if (!student) return;

            if (confirm(`Are you sure you want to delete ${student.name}?\n\nThis will also delete all their marks and cannot be undone.`)) {
                // Remove student
                const studentIndex = appData.students.findIndex(s => s.assessmentNumber === assessmentNumber);
                if (studentIndex > -1) {
                    appData.students.splice(studentIndex, 1);
                }
                
                // Remove all marks for this student
                appData.marks = appData.marks.filter(m => m.studentId !== assessmentNumber);
                
                saveData();
                showStudentManagement(); // Refresh the view
                alert('‚úÖ Student deleted successfully!');
            }
        }

        function filterStudents() {
            const grade = document.getElementById('gradeFilter').value;
            const tbody = document.getElementById('studentsTableBody');
            
            let filteredStudents = appData.students;
            if (grade) {
                filteredStudents = appData.students.filter(s => s.grade === grade);
            }

            tbody.innerHTML = filteredStudents.length === 0 ? 
                `<tr><td colspan="${currentUser.role === 'admin' ? '8' : '7'}" class="border border-gray-300 dark:border-gray-600 p-8 text-center text-gray-500">No students found for the selected criteria</td></tr>` :
                filteredStudents.map((student, index) => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 p-3">${index + 1}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.admissionNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.assessmentNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${student.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <span class="px-2 py-1 rounded text-xs ${student.gender === 'Male' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'}">
                                ${student.gender}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <span class="px-2 py-1 bg-primary text-white rounded text-sm">Grade ${student.grade}</span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-sm text-gray-600 dark:text-gray-400">
                            ${new Date(student.dateRegistered).toLocaleDateString()}
                        </td>
                        ${currentUser.role === 'admin' ? `
                            <td class="border border-gray-300 dark:border-gray-600 p-3">
                                <div class="flex space-x-1">
                                    <button onclick="editStudent('${student.assessmentNumber}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button onclick="deleteStudent('${student.assessmentNumber}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </td>
                        ` : ''}
                    </tr>
                `).join('');
        }

        function exportStudents() {
            const students = appData.students;
            if (students.length === 0) {
                alert('No students to export');
                return;
            }

            const csvContent = [
                ['S/No', 'Admission No', 'Assessment No', 'Name', 'Gender', 'Grade', 'Date Registered'].join(','),
                ...students.map((student, index) => [
                    index + 1,
                    student.admissionNumber,
                    student.assessmentNumber,
                    `"${student.name}"`,
                    student.gender,
                    student.grade,
                    new Date(student.dateRegistered).toLocaleDateString()
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rama_sda_students_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showTeacherManagement() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üë®‚Äçüè´ Teacher Management</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total: ${appData.teachers.length} teachers</span>
                            </div>
                        </div>
                        
                        <!-- Add Teacher Form -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 text-green-600">‚ûï Register New Teacher</h3>
                                <form id="teacherForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
                                        <input type="text" id="teacherName" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter teacher's full name">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Role <span class="text-red-500">*</span></label>
                                        <select id="teacherRole" class="w-full p-3 border rounded-lg text-base" required>
                                            <option value="">Select Role</option>
                                            <option value="Class Teacher">Class Teacher</option>
                                            <option value="Subject Teacher">Subject Teacher</option>
                                            <option value="Head Teacher">Head Teacher</option>
                                            <option value="Deputy Head Teacher">Deputy Head Teacher</option>
                                            <option value="Senior Teacher">Senior Teacher</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Subject Specialization <span class="text-red-500">*</span></label>
                                        <select id="teacherSubject" class="w-full p-3 border rounded-lg text-base" required>
                                            <option value="">Select Subject</option>
                                            ${appData.settings.subjects.map(subject => 
                                                `<option value="${subject.name}">${subject.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Class Assigned (Optional)</label>
                                        <select id="teacherClass" class="w-full p-3 border rounded-lg text-base">
                                            <option value="">Select Class (Optional)</option>
                                            ${appData.settings.grades.map(grade => 
                                                `<option value="${grade}">Grade ${grade}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                        üìù Register Teacher
                                    </button>
                                </form>
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 text-blue-600">üìä Teacher Statistics</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span>Total Teachers:</span>
                                        <span class="font-bold text-lg text-primary">${appData.teachers.length}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Class Teachers:</span>
                                        <span class="font-semibold">${appData.teachers.filter(t => t.role.includes('Class')).length}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Subject Teachers:</span>
                                        <span class="font-semibold">${appData.teachers.filter(t => t.role.includes('Subject')).length}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Senior Staff:</span>
                                        <span class="font-semibold">${appData.teachers.filter(t => t.role.includes('Head') || t.role.includes('Senior')).length}</span>
                                    </div>
                                    
                                    <div class="pt-3 border-t dark:border-gray-600">
                                        <h4 class="font-semibold mb-2 text-sm">Subject Coverage</h4>
                                        <div class="text-sm space-y-1">
                                            ${appData.settings.subjects.map(subject => {
                                                const teacherCount = appData.teachers.filter(t => t.subject === subject.name).length;
                                                return `
                                                    <div class="flex justify-between">
                                                        <span class="truncate">${subject.code}:</span>
                                                        <span class="${teacherCount === 0 ? 'text-red-500' : 'text-green-600'} font-semibold">
                                                            ${teacherCount || 'None'}
                                                        </span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Teacher List -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">üìã Registered Teachers</h3>
                            <div class="flex space-x-2">
                                <button onclick="exportTeachers()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
                                    üì• Export
                                </button>
                                <select id="subjectFilter" class="p-2 border rounded text-sm" onchange="filterTeachers()">
                                    <option value="">All Subjects</option>
                                    ${appData.settings.subjects.map(subject => `<option value="${subject.name}">${subject.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">S/No</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Name</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Role</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Subject</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Class</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Initials</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Date Registered</th>
                                        ${currentUser.role === 'admin' ? '<th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Actions</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody id="teachersTableBody">
                                    ${appData.teachers.length === 0 ? 
                                        `<tr><td colspan="${currentUser.role === 'admin' ? '8' : '7'}" class="border border-gray-300 dark:border-gray-600 p-8 text-center text-gray-500">No teachers registered yet</td></tr>` :
                                        appData.teachers.map((teacher, index) => `
                                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">${index + 1}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${teacher.name}</td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                    <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">
                                                        ${teacher.role}
                                                    </span>
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                    <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-xs">
                                                        ${teacher.subject}
                                                    </span>
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                    ${teacher.class ? `<span class="px-2 py-1 bg-primary text-white rounded text-sm">Grade ${teacher.class}</span>` : 'N/A'}
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono font-bold text-primary">
                                                    ${getTeacherInitials(teacher.name)}
                                                </td>
                                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-sm text-gray-600 dark:text-gray-400">
                                                    ${new Date(teacher.dateRegistered).toLocaleDateString()}
                                                </td>
                                                ${currentUser.role === 'admin' ? `
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                                        <div class="flex space-x-1">
                                                            <button onclick="editTeacher(${index})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                                                ‚úèÔ∏è Edit
                                                            </button>
                                                            <button onclick="deleteTeacher(${index})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                                                üóëÔ∏è Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                ` : ''}
                                            </tr>
                                        `).join('')
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Add event listener for teacher form
            document.getElementById('teacherForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('teacherName').value.trim();
                const role = document.getElementById('teacherRole').value;
                const subject = document.getElementById('teacherSubject').value;
                const classAssigned = document.getElementById('teacherClass').value;

                if (!name || !role || !subject) {
                    alert('Please fill in all required fields.');
                    return;
                }

                const teacher = {
                    name,
                    role,
                    subject,
                    class: classAssigned,
                    dateRegistered: new Date().toISOString()
                };

                appData.teachers.push(teacher);
                saveData();
                alert(`‚úÖ Teacher registered successfully!\n\nName: ${name}\nInitials: ${getTeacherInitials(name)}`);
                showTeacherManagement(); // Refresh the view
            });
        }

        function editTeacher(index) {
            const teacher = appData.teachers[index];
            if (!teacher) return;

            const newName = prompt('Enter new name:', teacher.name);
            if (!newName) return;

            const newRole = prompt('Enter new role:', teacher.role);
            if (!newRole) return;

            const newSubject = prompt('Enter new subject:', teacher.subject);
            if (!newSubject) return;

            teacher.name = newName.trim();
            teacher.role = newRole.trim();
            teacher.subject = newSubject.trim();
            saveData();
            showTeacherManagement(); // Refresh the view
            alert('‚úÖ Teacher updated successfully!');
        }

        function deleteTeacher(index) {
            const teacher = appData.teachers[index];
            if (!teacher) return;

            if (confirm(`Are you sure you want to delete ${teacher.name}?\n\nThis action cannot be undone.`)) {
                appData.teachers.splice(index, 1);
                saveData();
                showTeacherManagement(); // Refresh the view
                alert('‚úÖ Teacher deleted successfully!');
            }
        }

        function filterTeachers() {
            const subject = document.getElementById('subjectFilter').value;
            const tbody = document.getElementById('teachersTableBody');
            
            let filteredTeachers = appData.teachers;
            if (subject) {
                filteredTeachers = appData.teachers.filter(t => t.subject === subject);
            }

            tbody.innerHTML = filteredTeachers.length === 0 ? 
                `<tr><td colspan="${currentUser.role === 'admin' ? '8' : '7'}" class="border border-gray-300 dark:border-gray-600 p-8 text-center text-gray-500">No teachers found for the selected criteria</td></tr>` :
                filteredTeachers.map((teacher, index) => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 p-3">${index + 1}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${teacher.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">
                                ${teacher.role}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-xs">
                                ${teacher.subject}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            ${teacher.class ? `<span class="px-2 py-1 bg-primary text-white rounded text-sm">Grade ${teacher.class}</span>` : 'N/A'}
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono font-bold text-primary">
                            ${getTeacherInitials(teacher.name)}
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-sm text-gray-600 dark:text-gray-400">
                            ${new Date(teacher.dateRegistered).toLocaleDateString()}
                        </td>
                        ${currentUser.role === 'admin' ? `
                            <td class="border border-gray-300 dark:border-gray-600 p-3">
                                <div class="flex space-x-1">
                                    <button onclick="editTeacher(${appData.teachers.findIndex(t => t === teacher)})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button onclick="deleteTeacher(${appData.teachers.findIndex(t => t === teacher)})" class="bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </td>
                        ` : ''}
                    </tr>
                `).join('');
        }

        function exportTeachers() {
            const teachers = appData.teachers;
            if (teachers.length === 0) {
                alert('No teachers to export');
                return;
            }

            const csvContent = [
                ['S/No', 'Name', 'Role', 'Subject', 'Class', 'Initials', 'Date Registered'].join(','),
                ...teachers.map((teacher, index) => [
                    index + 1,
                    `"${teacher.name}"`,
                    `"${teacher.role}"`,
                    `"${teacher.subject}"`,
                    teacher.class || 'N/A',
                    getTeacherInitials(teacher.name),
                    new Date(teacher.dateRegistered).toLocaleDateString()
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rama_sda_teachers_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showMarksEntry() {
            const isAdmin = currentUser.role === 'admin';
            const canEditMarks = isAdmin; // Only admin can edit existing marks
            const contentArea = document.getElementById('contentArea');
            
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üìù Marks Entry System</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Academic Year ${appData.settings.currentYear}</span>
                            </div>
                        </div>
                        
                        <!-- Selection Parameters -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4 text-orange-600">üìã Exam Parameters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Academic Year <span class="text-red-500">*</span></label>
                                    <select id="marksYear" class="w-full p-3 border rounded-lg text-base">
                                        ${Array.from({length: 26}, (_, i) => 2025 + i).map(year => 
                                            `<option value="${year}" ${year === appData.settings.currentYear ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Term <span class="text-red-500">*</span></label>
                                    <select id="marksTerm" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Term</option>
                                        ${appData.settings.terms.map(term => `<option value="${term.name}">${term.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Exam Type <span class="text-red-500">*</span></label>
                                    <select id="marksExamType" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Type</option>
                                        ${appData.settings.examTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Grade/Class <span class="text-red-500">*</span></label>
                                    <select id="marksGrade" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Grade</option>
                                        ${appData.settings.grades.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Subject <span class="text-red-500">*</span></label>
                                    <select id="marksSubject" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Subject</option>
                                        ${appData.settings.subjects.map(subject => 
                                            `<option value="${subject.name}">${subject.name} (${subject.code})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-4 flex justify-between items-center">
                                <button id="loadStudentsBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition font-semibold">
                                    üîÑ Load Students
                                </button>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    <p class="mb-1">üìä <strong>Grading System:</strong></p>
                                    <p>EE: 75-100% | ME: 50-74% | AE: 25-49% | BE: 0-24%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Marks Entry Table -->
                    <div id="marksEntrySection" class="hidden bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">‚úèÔ∏è Enter Marks</h3>
                            <div id="marksEntryInfo" class="text-sm text-gray-600 dark:text-gray-400"></div>
                        </div>
                        
                        <form id="marksForm">
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                    <thead>
                                        <tr class="bg-gray-100 dark:bg-gray-700">
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">S/No</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">ADM NO</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Assessment No</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Name</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Gender</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Marks (0-100)</th>
                                            <th class="border border-gray-300 dark:border-gray-600 p-3 text-left">Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody id="marksTableBody"></tbody>
                                </table>
                            </div>
                            <div class="mt-6 flex justify-between items-center">
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    <p>üí° <strong>Tips:</strong> Enter marks from 0-100. Grades are calculated automatically.</p>
                                    ${!canEditMarks ? '<p class="text-red-500">‚ö†Ô∏è Only administrators can edit existing marks.</p>' : ''}
                                </div>
                                <button type="submit" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                                    üíæ Submit All Marks
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // Load students for marks entry
            document.getElementById('loadStudentsBtn').addEventListener('click', function() {
                const year = document.getElementById('marksYear').value;
                const term = document.getElementById('marksTerm').value;
                const examType = document.getElementById('marksExamType').value;
                const grade = document.getElementById('marksGrade').value;
                const subject = document.getElementById('marksSubject').value;

                if (!term || !examType || !grade || !subject) {
                    alert('‚ö†Ô∏è Please select all required fields before loading students.');
                    return;
                }

                const students = appData.students.filter(s => s.grade === grade);
                if (students.length === 0) {
                    alert(`No students found in Grade ${grade}.`);
                    return;
                }

                const tableBody = document.getElementById('marksTableBody');
                tableBody.innerHTML = '';

                students.forEach((student, index) => {
                    // Check if marks already exist
                    const existingMark = appData.marks.find(m => 
                        m.studentId === student.assessmentNumber &&
                        m.year == year &&
                        m.term === term &&
                        m.examType === examType &&
                        m.subject === subject
                    );

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
                    
                    const gradeInfo = existingMark ? calculateGrade(existingMark.mark) : null;
                    
                    row.innerHTML = `
                        <td class="border border-gray-300 dark:border-gray-600 p-3">${index + 1}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.admissionNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono">${student.assessmentNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${student.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <span class="px-2 py-1 rounded text-xs ${student.gender === 'Male' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'}">
                                ${student.gender}
                            </span>
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                            <input type="number" min="0" max="100" step="0.5"
                                   name="mark_${student.assessmentNumber}" 
                                   value="${existingMark ? existingMark.mark : ''}"
                                   ${!canEditMarks && existingMark ? 'readonly' : ''}
                                   class="w-full p-2 border rounded-lg text-base ${existingMark && !canEditMarks ? 'bg-gray-100 dark:bg-gray-600' : ''}" 
                                   placeholder="0-100"
                                   onchange="updateGradeDisplay(this, '${student.assessmentNumber}')">
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 p-3" id="grade_${student.assessmentNumber}">
                            ${gradeInfo ? `
                                <div class="flex space-x-1">
                                    <span class="px-2 py-1 rounded text-xs ${gradeInfo.class}">${gradeInfo.pl}</span>
                                    <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">${gradeInfo.al}</span>
                                    <span class="px-2 py-1 bg-primary text-white rounded text-xs">${gradeInfo.points}pts</span>
                                </div>
                            ` : '<span class="text-gray-400">-</span>'}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('marksEntrySection').classList.remove('hidden');
                document.getElementById('marksEntryInfo').innerHTML = `
                    <div>
                        <strong>${subject}</strong> ‚Ä¢ ${term} ${examType} ‚Ä¢ Grade ${grade} ‚Ä¢ ${year}<br>
                        <span class="text-xs">${students.length} students loaded</span>
                    </div>
                `;
            });

            // Submit marks
            document.getElementById('marksForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const year = document.getElementById('marksYear').value;
                const term = document.getElementById('marksTerm').value;
                const examType = document.getElementById('marksExamType').value;
                const grade = document.getElementById('marksGrade').value;
                const subject = document.getElementById('marksSubject').value;
                
                const formData = new FormData(e.target);
                let marksSubmitted = 0;
                let marksUpdated = 0;

                for (const [key, value] of formData.entries()) {
                    if (key.startsWith('mark_') && value !== '') {
                        const studentId = key.replace('mark_', '');
                        const mark = parseFloat(value);
                        
                        if (mark >= 0 && mark <= 100) {
                            // Remove existing mark if any
                            const existingIndex = appData.marks.findIndex(m => 
                                m.studentId === studentId &&
                                m.year == year &&
                                m.term === term &&
                                m.examType === examType &&
                                m.subject === subject
                            );
                            
                            if (existingIndex > -1) {
                                appData.marks.splice(existingIndex, 1);
                                marksUpdated++;
                            } else {
                                marksSubmitted++;
                            }
                            
                            // Add new mark
                            const gradeInfo = calculateGrade(mark);
                            appData.marks.push({
                                studentId,
                                year: parseInt(year),
                                term,
                                examType,
                                grade,
                                subject,
                                mark,
                                pl: gradeInfo.pl,
                                al: gradeInfo.al,
                                points: gradeInfo.points,
                                enteredBy: currentUser.username,
                                dateEntered: new Date().toISOString()
                            });
                        }
                    }
                }

                saveData();
                alert(`‚úÖ Marks processed successfully!\n\nüìù New marks: ${marksSubmitted}\n‚úèÔ∏è Updated marks: ${marksUpdated}\nüìä Total: ${marksSubmitted + marksUpdated}`);
                
                // Refresh the loaded students to show updated data
                document.getElementById('loadStudentsBtn').click();
            });
        }

        // Update grade display in real-time
        function updateGradeDisplay(input, studentId) {
            const mark = parseFloat(input.value);
            const gradeCell = document.getElementById(`grade_${studentId}`);
            
            if (isNaN(mark) || mark < 0 || mark > 100) {
                gradeCell.innerHTML = '<span class="text-gray-400">-</span>';
                return;
            }
            
            const gradeInfo = calculateGrade(mark);
            gradeCell.innerHTML = `
                <div class="flex space-x-1">
                    <span class="px-2 py-1 rounded text-xs ${gradeInfo.class}">${gradeInfo.pl}</span>
                    <span class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">${gradeInfo.al}</span>
                    <span class="px-2 py-1 bg-primary text-white rounded text-xs">${gradeInfo.points}pts</span>
                </div>
            `;
        }

        function showReports() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üìÑ Reports & Printing</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Academic Year ${appData.settings.currentYear}</span>
                            </div>
                        </div>
                        
                        <!-- Report Types -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 p-6 rounded-lg">
                                <div class="text-center">
                                    <div class="text-4xl mb-3">üìã</div>
                                    <h3 class="text-lg font-semibold mb-3 text-blue-700 dark:text-blue-300">Mark Sheets</h3>
                                    <p class="text-sm text-blue-600 dark:text-blue-400 mb-4">Generate blank mark sheets for manual entry and evidence</p>
                                    <button onclick="generateMarkSheet()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition w-full font-semibold">
                                        Generate Mark Sheet
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 p-6 rounded-lg">
                                <div class="text-center">
                                    <div class="text-4xl mb-3">üìä</div>
                                    <h3 class="text-lg font-semibold mb-3 text-green-700 dark:text-green-300">Result Sheets</h3>
                                    <p class="text-sm text-green-600 dark:text-green-400 mb-4">Print compiled results with analysis and rankings</p>
                                    <button onclick="generateResultSheet()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition w-full font-semibold">
                                        Generate Results
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 dark:bg-purple-900 border border-purple-200 dark:border-purple-700 p-6 rounded-lg">
                                <div class="text-center">
                                    <div class="text-4xl mb-3">üéì</div>
                                    <h3 class="text-lg font-semibold mb-3 text-purple-700 dark:text-purple-300">Report Cards</h3>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 mb-4">Individual student report cards with signatures</p>
                                    <button onclick="generateReportCard()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition w-full font-semibold">
                                        Generate Report Card
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Parameters -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-orange-600">‚öôÔ∏è Report Parameters</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Academic Year</label>
                                    <select id="reportYear" class="w-full p-3 border rounded-lg text-base">
                                        ${Array.from({length: 26}, (_, i) => 2025 + i).map(year => 
                                            `<option value="${year}" ${year === appData.settings.currentYear ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Term</label>
                                    <select id="reportTerm" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Term</option>
                                        ${appData.settings.terms.map(term => `<option value="${term.name}">${term.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Grade/Class</label>
                                    <select id="reportGrade" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Grade</option>
                                        ${appData.settings.grades.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Student (for individual reports)</label>
                                    <select id="reportStudent" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Student</option>
                                        ${appData.students.map(student => 
                                            `<option value="${student.assessmentNumber}">${student.name} (${student.assessmentNumber})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Report Type</label>
                                    <select id="reportType" class="w-full p-3 border rounded-lg text-base">
                                        <option value="individual">Individual Student</option>
                                        <option value="class">Entire Class</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-blue-600">üìà Quick Statistics</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span>üìö Total Students:</span>
                                    <span class="font-bold text-lg text-primary">${appData.students.length}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>üìù Marks Entries:</span>
                                    <span class="font-bold text-lg text-green-600">${appData.marks.length}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>üìã Learning Areas:</span>
                                    <span class="font-bold text-lg text-blue-600">${appData.settings.subjects.length}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>üéØ Active Year:</span>
                                    <span class="font-bold text-lg text-orange-600">${appData.settings.currentYear}</span>
                                </div>
                                
                                <div class="pt-3 border-t dark:border-gray-600">
                                    <h4 class="font-semibold mb-2 text-sm">üìä Marks Distribution</h4>
                                    ${appData.settings.grades.map(grade => {
                                        const gradeMarks = appData.marks.filter(m => m.grade === grade && m.year == appData.settings.currentYear);
                                        return `
                                            <div class="flex justify-between text-sm">
                                                <span>Grade ${grade}:</span>
                                                <span class="font-semibold">${gradeMarks.length} entries</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Preview -->
                <div id="reportPreview" class="mt-6 hidden bg-white dark:bg-gray-800 rounded-lg shadow-md">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-primary">üìÑ Report Preview</h3>
                        <div class="flex space-x-2">
                            <button onclick="printReport()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition no-print font-semibold">
                                üñ®Ô∏è Print Report
                            </button>
                            <button onclick="closeReportPreview()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition no-print">
                                ‚úñÔ∏è Close
                            </button>
                        </div>
                    </div>
                    <div id="reportContent" class="p-6"></div>
                </div>
            `;
        }

        function generateMarkSheet() {
            const year = document.getElementById('reportYear').value;
            const term = document.getElementById('reportTerm').value;
            const grade = document.getElementById('reportGrade').value;

            if (!term || !grade) {
                alert('‚ö†Ô∏è Please select term and grade.');
                return;
            }

            const students = appData.students.filter(s => s.grade === grade).sort((a, b) => a.name.localeCompare(b.name));
            
            if (students.length === 0) {
                alert(`No students found in Grade ${grade}.`);
                return;
            }

            const reportContent = `
                <div class="print-container max-w-full">
                    <div class="text-center mb-6">
                        <div class="flex justify-center items-center mb-4">
                            <div class="logo-container mr-4"></div>
                            <div>
                                <h1 class="text-2xl font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                                <p class="text-sm">P.O. BOX 45-50201, CHEPTAIS</p>
                                <p class="text-xs italic font-semibold text-primary">"IN GOD WE CAN"</p>
                            </div>
                        </div>
                        <div class="border-t-2 border-b-2 border-gray-400 py-2 my-4">
                            <h2 class="text-xl font-bold">EXAMINATION MARK SHEET - ${year}</h2>
                            <p class="text-base font-semibold">${term} | Grade ${grade} | Total Students: ${students.length}</p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border-2 border-black text-sm">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border border-black p-2 font-bold">S/No</th>
                                    <th class="border border-black p-2 font-bold">ADM NO</th>
                                    <th class="border border-black p-2 font-bold">Assessment No</th>
                                    <th class="border border-black p-2 font-bold">LEARNER'S NAME</th>
                                    <th class="border border-black p-2 font-bold">GENDER</th>
                                    ${appData.settings.subjects.map(subject => 
                                        `<th class="border border-black p-1 font-bold text-xs vertical-text" style="writing-mode: vertical-lr; text-orientation: mixed;">${subject.code}</th>`
                                    ).join('')}
                                    <th class="border border-black p-1 font-bold">TOTAL</th>
                                    <th class="border border-black p-1 font-bold">AVG</th>
                                    <th class="border border-black p-1 font-bold">RANK</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.map((student, index) => `
                                    <tr style="height: 40px;">
                                        <td class="border border-black p-2 text-center font-semibold">${index + 1}</td>
                                        <td class="border border-black p-2 text-center font-mono">${student.admissionNumber}</td>
                                        <td class="border border-black p-2 text-center font-mono">${student.assessmentNumber}</td>
                                        <td class="border border-black p-2 font-semibold">${student.name.toUpperCase()}</td>
                                        <td class="border border-black p-2 text-center">${student.gender.charAt(0)}</td>
                                        ${appData.settings.subjects.map(() => 
                                            `<td class="border border-black p-2" style="height: 40px;"></td>`
                                        ).join('')}
                                        <td class="border border-black p-2"></td>
                                        <td class="border border-black p-2"></td>
                                        <td class="border border-black p-2"></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-2 gap-8 text-sm">
                        <div>
                            <p class="mb-2"><strong>SUBJECT TEACHER:</strong></p>
                            <p>Name: ____________________________________</p>
                            <p>Signature: ______________________ Date: ______________________</p>
                        </div>
                        <div>
                            <p class="mb-2"><strong>HEAD OF INSTITUTION:</strong></p>
                            <p>Name: ____________________________________</p>
                            <p>Signature: ______________________ Date: ______________________</p>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-xs">
                        <div class="bg-gray-100 p-3 rounded">
                            <p><strong>GRADING SYSTEM:</strong> EE (75-100%) | ME (50-74%) | AE (25-49%) | BE (0-24%)</p>
                            <p><strong>ACHIEVEMENT LEVELS:</strong> AL8 (88-100) | AL7 (75-87) | AL6 (62-74) | AL5 (50-61) | AL4 (37-49) | AL3 (25-36) | AL2 (12-24) | AL1 (0-11)</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').classList.remove('hidden');
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateResultSheet() {
            const year = document.getElementById('reportYear').value;
            const term = document.getElementById('reportTerm').value;
            const grade = document.getElementById('reportGrade').value;

            if (!term || !grade) {
                alert('‚ö†Ô∏è Please select term and grade.');
                return;
            }

            const students = appData.students.filter(s => s.grade === grade);
            if (students.length === 0) {
                alert(`No students found in Grade ${grade}.`);
                return;
            }

            const results = [];

            students.forEach(student => {
                const studentMarks = appData.marks.filter(m => 
                    m.studentId === student.assessmentNumber &&
                    m.year == year &&
                    m.term === term &&
                    m.grade === grade
                );

                let totalMarks = 0;
                let totalPoints = 0;
                let subjectCount = 0;
                const subjectResults = {};

                appData.settings.subjects.forEach(subject => {
                    const mark = studentMarks.find(m => m.subject === subject.name);
                    if (mark) {
                        subjectResults[subject.name] = {
                            mark: mark.mark,
                            pl: mark.pl,
                            al: mark.al,
                            points: mark.points
                        };
                        totalMarks += mark.mark;
                        totalPoints += mark.points;
                        subjectCount++;
                    } else {
                        subjectResults[subject.name] = null;
                    }
                });

                const average = subjectCount > 0 ? (totalMarks / subjectCount) : 0;
                const generalGrade = calculateGrade(average);

                results.push({
                    student,
                    subjectResults,
                    totalMarks,
                    average: parseFloat(average.toFixed(1)),
                    totalPoints,
                    generalPL: generalGrade.pl,
                    generalAL: generalGrade.al,
                    subjectCount
                });
            });

            // Sort by total points (ranking)
            results.sort((a, b) => b.totalPoints - a.totalPoints);

            // Calculate gender statistics
            const genderStats = {
                male: { EE: 0, ME: 0, AE: 0, BE: 0, total: 0 },
                female: { EE: 0, ME: 0, AE: 0, BE: 0, total: 0 }
            };

            results.forEach(result => {
                const gender = result.student.gender.toLowerCase();
                if (genderStats[gender] && result.subjectCount > 0) {
                    genderStats[gender].total++;
                    genderStats[gender][result.generalPL]++;
                }
            });

            // Subject analysis
            const subjectAnalysis = {};
            appData.settings.subjects.forEach(subject => {
                const subjectMarks = appData.marks.filter(m => 
                    m.subject === subject.name &&
                    m.year == year &&
                    m.term === term &&
                    m.grade === grade
                );
                
                if (subjectMarks.length > 0) {
                    const marks = subjectMarks.map(m => m.mark);
                    subjectAnalysis[subject.name] = {
                        average: (marks.reduce((sum, mark) => sum + mark, 0) / marks.length).toFixed(1),
                        highest: Math.max(...marks),
                        lowest: Math.min(...marks),
                        count: marks.length
                    };
                }
            });

            const reportContent = `
                <div class="print-container max-w-full">
                    <div class="text-center mb-6">
                        <div class="flex justify-center items-center mb-4">
                            <div class="logo-container mr-4"></div>
                            <div>
                                <h1 class="text-2xl font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                                <p class="text-sm">P.O. BOX 45-50201, CHEPTAIS</p>
                                <p class="text-xs italic font-semibold text-primary">"IN GOD WE CAN"</p>
                            </div>
                        </div>
                        <div class="border-t-2 border-b-2 border-gray-400 py-2 my-4">
                            <h2 class="text-xl font-bold">EXAMINATION RESULTS ANALYSIS - ${year}</h2>
                            <p class="text-base font-semibold">${term} | Grade ${grade} | Total Students: ${results.length}</p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full border-collapse border border-black text-xs">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border border-black p-1 font-bold">S/No</th>
                                    <th class="border border-black p-1 font-bold">Assessment No</th>
                                    <th class="border border-black p-1 font-bold">Name</th>
                                    <th class="border border-black p-1 font-bold">Gender</th>
                                    ${appData.settings.subjects.map(subject => 
                                        `<th class="border border-black p-1 font-bold">${subject.code}</th>`
                                    ).join('')}
                                    <th class="border border-black p-1 font-bold">Total</th>
                                    <th class="border border-black p-1 font-bold">Avg</th>
                                    <th class="border border-black p-1 font-bold">Points</th>
                                    <th class="border border-black p-1 font-bold">Gen PL</th>
                                    <th class="border border-black p-1 font-bold">Gen AL</th>
                                    <th class="border border-black p-1 font-bold">Rank</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.map((result, index) => `
                                    <tr>
                                        <td class="border border-black p-1 text-center font-semibold">${index + 1}</td>
                                        <td class="border border-black p-1 text-center font-mono">${result.student.assessmentNumber}</td>
                                        <td class="border border-black p-1 font-semibold">${result.student.name}</td>
                                        <td class="border border-black p-1 text-center">${result.student.gender.charAt(0)}</td>
                                        ${appData.settings.subjects.map(subject => {
                                            const subjectResult = result.subjectResults[subject.name];
                                            return `<td class="border border-black p-1 text-center">${
                                                subjectResult ? `${subjectResult.mark}<br/><small class="text-xs">${subjectResult.pl}</small>` : '-'
                                            }</td>`;
                                        }).join('')}
                                        <td class="border border-black p-1 text-center font-bold">${result.totalMarks}</td>
                                        <td class="border border-black p-1 text-center font-bold">${result.average}</td>
                                        <td class="border border-black p-1 text-center font-bold">${result.totalPoints}</td>
                                        <td class="border border-black p-1 text-center font-bold ${calculateGrade(result.average).class}">${result.generalPL}</td>
                                        <td class="border border-black p-1 text-center font-bold">${result.generalAL}</td>
                                        <td class="border border-black p-1 text-center font-bold text-primary">${index + 1}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="font-bold mb-3 text-center bg-gray-200 p-2">GENDER PERFORMANCE ANALYSIS</h3>
                            <table class="w-full border-collapse border border-black text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-black p-2">Gender</th>
                                        <th class="border border-black p-2">EE</th>
                                        <th class="border border-black p-2">ME</th>
                                        <th class="border border-black p-2">AE</th>
                                        <th class="border border-black p-2">BE</th>
                                        <th class="border border-black p-2">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="border border-black p-2 font-semibold">Male</td>
                                        <td class="border border-black p-2 text-center">${genderStats.male.EE}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.male.ME}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.male.AE}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.male.BE}</td>
                                        <td class="border border-black p-2 text-center font-bold">${genderStats.male.total}</td>
                                    </tr>
                                    <tr>
                                        <td class="border border-black p-2 font-semibold">Female</td>
                                        <td class="border border-black p-2 text-center">${genderStats.female.EE}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.female.ME}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.female.AE}</td>
                                        <td class="border border-black p-2 text-center">${genderStats.female.BE}</td>
                                        <td class="border border-black p-2 text-center font-bold">${genderStats.female.total}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div>
                            <h3 class="font-bold mb-3 text-center bg-gray-200 p-2">SUBJECT PERFORMANCE ANALYSIS</h3>
                            <table class="w-full border-collapse border border-black text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-black p-2">Subject</th>
                                        <th class="border border-black p-2">Avg</th>
                                        <th class="border border-black p-2">High</th>
                                        <th class="border border-black p-2">Low</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appData.settings.subjects.map(subject => {
                                        const analysis = subjectAnalysis[subject.name];
                                        return `
                                            <tr>
                                                <td class="border border-black p-2 font-semibold">${subject.code}</td>
                                                <td class="border border-black p-2 text-center">${analysis ? analysis.average : '-'}</td>
                                                <td class="border border-black p-2 text-center">${analysis ? analysis.highest : '-'}</td>
                                                <td class="border border-black p-2 text-center">${analysis ? analysis.lowest : '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-bold mb-3 text-center bg-gray-200 p-2">SUMMARY STATISTICS</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="text-center">
                                <p class="font-semibold">Total Students</p>
                                <p class="text-2xl font-bold text-primary">${results.length}</p>
                            </div>
                            <div class="text-center">
                                <p class="font-semibold">Class Average</p>
                                <p class="text-2xl font-bold text-green-600">${results.length > 0 ? (results.reduce((sum, r) => sum + r.average, 0) / results.length).toFixed(1) : 0}%</p>
                            </div>
                            <div class="text-center">
                                <p class="font-semibold">Highest Score</p>
                                <p class="text-2xl font-bold text-blue-600">${results.length > 0 ? Math.max(...results.map(r => r.totalMarks)) : 0}</p>
                            </div>
                            <div class="text-center">
                                <p class="font-semibold">Lowest Score</p>
                                <p class="text-2xl font-bold text-red-600">${results.length > 0 ? Math.min(...results.map(r => r.totalMarks)) : 0}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').classList.remove('hidden');
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateReportCard() {
            const year = document.getElementById('reportYear').value;
            const term = document.getElementById('reportTerm').value;
            const studentId = document.getElementById('reportStudent').value;
            const reportType = document.getElementById('reportType').value;

            if (!term) {
                alert('‚ö†Ô∏è Please select a term.');
                return;
            }

            if (reportType === 'individual' && !studentId) {
                alert('‚ö†Ô∏è Please select a student for individual report.');
                return;
            }

            if (reportType === 'class') {
                generateClassReportCards();
                return;
            }

            const student = appData.students.find(s => s.assessmentNumber === studentId);
            if (!student) {
                alert('‚ùå Student not found.');
                return;
            }

            generateIndividualReportCard(student, year, term);
        }

        function generateIndividualReportCard(student, year, term) {
            const studentMarks = appData.marks.filter(m => 
                m.studentId === student.assessmentNumber &&
                m.year == year &&
                m.term === term
            );

            let totalPoints = 0;
            let subjectCount = 0;
            let totalMarks = 0;

            const subjectRows = appData.settings.subjects.map(subject => {
                const mark = studentMarks.find(m => m.subject === subject.name);
                if (mark) {
                    totalPoints += mark.points;
                    totalMarks += mark.mark;
                    subjectCount++;
                    const teacher = appData.teachers.find(t => t.subject === subject.name);
                    return `
                        <tr>
                            <td class="border border-black p-2">${subject.name}</td>
                            <td class="border border-black p-2 text-center">${subject.code}</td>
                            <td class="border border-black p-2 text-center font-bold">${mark.mark}%</td>
                            <td class="border border-black p-2 text-center font-bold ${calculateGrade(mark.mark).class}">${mark.pl}</td>
                            <td class="border border-black p-2 text-center font-bold">${mark.al}</td>
                            <td class="border border-black p-2 text-center">${teacher ? getTeacherInitials(teacher.name) : ''}</td>
                            <td class="border border-black p-2" style="min-width: 100px;">_____________</td>
                        </tr>
                    `;
                } else {
                    return `
                        <tr>
                            <td class="border border-black p-2">${subject.name}</td>
                            <td class="border border-black p-2 text-center">${subject.code}</td>
                            <td class="border border-black p-2 text-center">-</td>
                            <td class="border border-black p-2 text-center">-</td>
                            <td class="border border-black p-2 text-center">-</td>
                            <td class="border border-black p-2 text-center">-</td>
                            <td class="border border-black p-2">_____________</td>
                        </tr>
                    `;
                }
            }).join('');

            const average = subjectCount > 0 ? totalMarks / subjectCount : 0;
            const generalGrade = calculateGrade(average);
            const generalPLFull = getPerformanceLevelFull(generalGrade.pl);

            const reportContent = `
                <div class="print-container max-w-4xl mx-auto">
                    <div class="text-center mb-6">
                        <div class="flex justify-center items-center mb-4">
                            <div class="logo-container mr-4"></div>
                            <div>
                                <h1 class="text-2xl font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                                <p class="text-sm">P.O. BOX 45-50201, CHEPTAIS</p>
                                <p class="text-xs italic font-semibold text-primary">"IN GOD WE CAN"</p>
                            </div>
                        </div>
                        <div class="border-t-2 border-b-2 border-gray-400 py-2 my-4">
                            <h2 class="text-xl font-bold">STUDENT REPORT CARD</h2>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6 text-sm">
                        <div class="space-y-2">
                            <p><strong>NAME:</strong> ${student.name.toUpperCase()}</p>
                            <p><strong>ASSESSMENT NO:</strong> ${student.assessmentNumber}</p>
                            <p><strong>ADMISSION NO:</strong> ${student.admissionNumber}</p>
                        </div>
                        <div class="space-y-2">
                            <p><strong>CLASS:</strong> Grade ${student.grade}</p>
                            <p><strong>YEAR:</strong> ${year}</p>
                            <p><strong>TERM:</strong> ${term}</p>
                        </div>
                    </div>
                    
                    <table class="w-full border-collapse border-2 border-black text-sm mb-6">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="border border-black p-2 font-bold">LEARNING AREA</th>
                                <th class="border border-black p-2 font-bold">CODE</th>
                                <th class="border border-black p-2 font-bold">PERCENTAGE</th>
                                <th class="border border-black p-2 font-bold">PL</th>
                                <th class="border border-black p-2 font-bold">AL</th>
                                <th class="border border-black p-2 font-bold">TEACHER INITIALS</th>
                                <th class="border border-black p-2 font-bold">COMMENTS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjectRows}
                        </tbody>
                    </table>
                    
                    <div class="mb-6 text-sm bg-gray-100 p-4 rounded">
                        <div class="grid grid-cols-2 gap-4">
                            <p><strong>GENERAL PERFORMANCE LEVEL:</strong> ${generalPLFull}</p>
                            <p><strong>TOTAL POINTS:</strong> ${totalPoints} / 72</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 text-sm">
                        <div class="border-2 border-black p-4">
                            <p class="font-bold mb-2">CLASS TEACHER COMMENTS:</p>
                            <div class="mt-3" style="height: 60px; border-bottom: 1px solid #ccc;"></div>
                        </div>
                        
                        <div class="border-2 border-black p-4">
                            <p class="font-bold mb-2">HEAD OF INSTITUTION COMMENTS:</p>
                            <div class="mt-3" style="height: 60px; border-bottom: 1px solid #ccc;"></div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-6 mt-6">
                            <div class="text-center">
                                <p class="font-bold mb-4">CLASS TEACHER</p>
                                <div class="mt-12 border-t-2 border-black pt-1">
                                    <p class="text-xs">Signature & Date</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="font-bold mb-4">HEAD OF INSTITUTION</p>
                                <div class="mt-12 border-t-2 border-black pt-1">
                                    <p class="text-xs">Signature & Date</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="font-bold mb-4">PARENT/GUARDIAN</p>
                                <div class="mt-12 border-t-2 border-black pt-1">
                                    <p class="text-xs">Signature & Date</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6 mt-6">
                            <div class="text-center">
                                <p class="font-bold">TERM OPENING:</p>
                                <div class="mt-4 border-b-2 border-black" style="height: 30px;"></div>
                            </div>
                            <div class="text-center">
                                <p class="font-bold">TERM CLOSING:</p>
                                <div class="mt-4 border-b-2 border-black" style="height: 30px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = reportContent;
            document.getElementById('reportPreview').classList.remove('hidden');
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function generateClassReportCards() {
            const year = document.getElementById('reportYear').value;
            const term = document.getElementById('reportTerm').value;
            const grade = document.getElementById('reportGrade').value;

            if (!grade) {
                alert('‚ö†Ô∏è Please select a grade for class report cards.');
                return;
            }

            const students = appData.students.filter(s => s.grade === grade);
            if (students.length === 0) {
                alert(`No students found in Grade ${grade}.`);
                return;
            }

            let allReportCards = '';
            students.forEach((student, index) => {
                if (index > 0) {
                    allReportCards += '<div style="page-break-before: always;"></div>';
                }
                
                const studentMarks = appData.marks.filter(m => 
                    m.studentId === student.assessmentNumber &&
                    m.year == year &&
                    m.term === term
                );

                let totalPoints = 0;
                let subjectCount = 0;
                let totalMarks = 0;

                const subjectRows = appData.settings.subjects.map(subject => {
                    const mark = studentMarks.find(m => m.subject === subject.name);
                    if (mark) {
                        totalPoints += mark.points;
                        totalMarks += mark.mark;
                        subjectCount++;
                        const teacher = appData.teachers.find(t => t.subject === subject.name);
                        return `
                            <tr>
                                <td class="border border-black p-2">${subject.name}</td>
                                <td class="border border-black p-2 text-center">${subject.code}</td>
                                <td class="border border-black p-2 text-center font-bold">${mark.mark}%</td>
                                <td class="border border-black p-2 text-center font-bold ${calculateGrade(mark.mark).class}">${mark.pl}</td>
                                <td class="border border-black p-2 text-center font-bold">${mark.al}</td>
                                <td class="border border-black p-2 text-center">${teacher ? getTeacherInitials(teacher.name) : ''}</td>
                                <td class="border border-black p-2">_____________</td>
                            </tr>
                        `;
                    } else {
                        return `
                            <tr>
                                <td class="border border-black p-2">${subject.name}</td>
                                <td class="border border-black p-2 text-center">${subject.code}</td>
                                <td class="border border-black p-2 text-center">-</td>
                                <td class="border border-black p-2 text-center">-</td>
                                <td class="border border-black p-2 text-center">-</td>
                                <td class="border border-black p-2 text-center">-</td>
                                <td class="border border-black p-2">_____________</td>
                            </tr>
                        `;
                    }
                }).join('');

                const average = subjectCount > 0 ? totalMarks / subjectCount : 0;
                const generalGrade = calculateGrade(average);
                const generalPLFull = getPerformanceLevelFull(generalGrade.pl);

                allReportCards += `
                    <div class="print-container max-w-4xl mx-auto mb-8">
                        <div class="text-center mb-4">
                            <div class="flex justify-center items-center mb-3">
                                <div class="logo-container small-logo mr-3"></div>
                                <div>
                                    <h1 class="text-lg font-bold text-secondary">RAMA SDA JUNIOR SCHOOL</h1>
                                    <p class="text-xs">P.O. BOX 45-50201, CHEPTAIS</p>
                                    <p class="text-xs italic font-semibold text-primary">"IN GOD WE CAN"</p>
                                </div>
                            </div>
                            <div class="border-t border-b border-gray-400 py-1 my-2">
                                <h2 class="text-base font-bold">STUDENT REPORT CARD</h2>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4 text-xs">
                            <div class="space-y-1">
                                <p><strong>NAME:</strong> ${student.name.toUpperCase()}</p>
                                <p><strong>ASSESSMENT NO:</strong> ${student.assessmentNumber}</p>
                                <p><strong>ADMISSION NO:</strong> ${student.admissionNumber}</p>
                            </div>
                            <div class="space-y-1">
                                <p><strong>CLASS:</strong> Grade ${student.grade}</p>
                                <p><strong>YEAR:</strong> ${year}</p>
                                <p><strong>TERM:</strong> ${term}</p>
                            </div>
                        </div>
                        
                        <table class="w-full border-collapse border border-black text-xs mb-3">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border border-black p-1 font-bold">LEARNING AREA</th>
                                    <th class="border border-black p-1 font-bold">CODE</th>
                                    <th class="border border-black p-1 font-bold">%</th>
                                    <th class="border border-black p-1 font-bold">PL</th>
                                    <th class="border border-black p-1 font-bold">AL</th>
                                    <th class="border border-black p-1 font-bold">INIT</th>
                                    <th class="border border-black p-1 font-bold">COMMENTS</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjectRows}
                            </tbody>
                        </table>
                        
                        <div class="mb-3 text-xs bg-gray-100 p-2 rounded">
                            <div class="grid grid-cols-2 gap-2">
                                <p><strong>GENERAL PL:</strong> ${generalPLFull}</p>
                                <p><strong>TOTAL POINTS:</strong> ${totalPoints} / 72</p>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-xs">
                            <div class="border border-black p-2">
                                <p class="font-bold mb-1">CLASS TEACHER COMMENTS:</p>
                                <div style="height: 30px; border-bottom: 1px solid #ccc;"></div>
                            </div>
                            
                            <div class="border border-black p-2">
                                <p class="font-bold mb-1">HEAD OF INSTITUTION COMMENTS:</p>
                                <div style="height: 30px; border-bottom: 1px solid #ccc;"></div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-3 mt-3">
                                <div class="text-center">
                                    <p class="font-bold text-xs">CLASS TEACHER</p>
                                    <div class="mt-6 border-t border-black pt-1">
                                        <p style="font-size: 8px;">Signature & Date</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-xs">HEAD OF INSTITUTION</p>
                                    <div class="mt-6 border-t border-black pt-1">
                                        <p style="font-size: 8px;">Signature & Date</p>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <p class="font-bold text-xs">PARENT/GUARDIAN</p>
                                    <div class="mt-6 border-t border-black pt-1">
                                        <p style="font-size: 8px;">Signature & Date</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('reportContent').innerHTML = allReportCards;
            document.getElementById('reportPreview').classList.remove('hidden');
            document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
        }

        function printReport() {
            window.print();
        }

        function closeReportPreview() {
            document.getElementById('reportPreview').classList.add('hidden');
        }

        function showAnalysis() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üìà Performance Analysis</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Academic Year ${appData.settings.currentYear}</span>
                            </div>
                        </div>
                        
                        <!-- Analysis Parameters -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4 text-indigo-600">üîç Analysis Parameters</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Academic Year</label>
                                    <select id="analysisYear" class="w-full p-3 border rounded-lg text-base">
                                        ${Array.from({length: 26}, (_, i) => 2025 + i).map(year => 
                                            `<option value="${year}" ${year === appData.settings.currentYear ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Term</label>
                                    <select id="analysisTerm" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Term</option>
                                        ${appData.settings.terms.map(term => `<option value="${term.name}">${term.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Grade</label>
                                    <select id="analysisGrade" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Grade</option>
                                        ${appData.settings.grades.map(grade => `<option value="${grade}">Grade ${grade}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="generateAnalysisBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition w-full font-semibold">
                                        üöÄ Generate Analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div id="analysisResults" class="hidden space-y-6">
                        <!-- Champions & Top Performers -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-4 text-yellow-600">üèÜ Subject Champions</h3>
                                <div id="subjectChampions" class="space-y-2"></div>
                            </div>
                            
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold mb-4 text-blue-600">üìä Overall Statistics</h3>
                                <div id="overallStats" class="space-y-2"></div>
                            </div>
                        </div>
                        
                        <!-- Gender Analysis -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-purple-600">üë• Gender Performance Analysis</h3>
                            <div id="genderBreakdown"></div>
                        </div>
                        
                        <!-- Subject Analysis -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-green-600">üìö Learning Area Analysis</h3>
                            <div id="subjectAnalysis"></div>
                        </div>
                        
                        <!-- Top Performers -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">üåü Top 10 Performers</h3>
                            <div id="topPerformers"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('generateAnalysisBtn').addEventListener('click', function() {
                const year = document.getElementById('analysisYear').value;
                const term = document.getElementById('analysisTerm').value;
                const grade = document.getElementById('analysisGrade').value;

                if (!term || !grade) {
                    alert('‚ö†Ô∏è Please select term and grade.');
                    return;
                }

                generateAnalysisReport(year, term, grade);
            });
        }

        function generateAnalysisReport(year, term, grade) {
            const students = appData.students.filter(s => s.grade === grade);
            const marks = appData.marks.filter(m => 
                m.year == year && m.term === term && m.grade === grade
            );

            if (marks.length === 0) {
                alert('‚ùå No marks data found for the selected criteria.');
                return;
            }

            // Subject Champions
            const subjectChampions = {};
            appData.settings.subjects.forEach(subject => {
                const subjectMarks = marks.filter(m => m.subject === subject.name);
                if (subjectMarks.length > 0) {
                    const topMark = Math.max(...subjectMarks.map(m => m.mark));
                    const champions = subjectMarks.filter(m => m.mark === topMark);
                    const championStudents = champions.map(c => {
                        const student = students.find(s => s.assessmentNumber === c.studentId);
                        return student ? student.name : 'Unknown';
                    });
                    subjectChampions[subject.name] = {
                        students: championStudents,
                        mark: topMark,
                        code: subject.code
                    };
                }
            });

            // Overall Statistics
            const allMarks = marks.map(m => m.mark);
            const allPoints = marks.map(m => m.points);
            const stats = {
                totalStudents: students.length,
                totalMarksEntries: marks.length,
                averageMark: allMarks.length > 0 ? (allMarks.reduce((a, b) => a + b, 0) / allMarks.length).toFixed(1) : 0,
                averagePoints: allPoints.length > 0 ? (allPoints.reduce((a, b) => a + b, 0) / allPoints.length).toFixed(1) : 0,
                highestMark: allMarks.length > 0 ? Math.max(...allMarks) : 0,
                lowestMark: allMarks.length > 0 ? Math.min(...allMarks) : 0,
                passRate: allMarks.length > 0 ? ((allMarks.filter(m => m >= 50).length / allMarks.length) * 100).toFixed(1) : 0
            };

            // Student Results for Ranking
            const studentResults = [];
            students.forEach(student => {
                const studentMarks = marks.filter(m => m.studentId === student.assessmentNumber);
                if (studentMarks.length > 0) {
                    const totalMarks = studentMarks.reduce((sum, m) => sum + m.mark, 0);
                    const totalPoints = studentMarks.reduce((sum, m) => sum + m.points, 0);
                    const average = totalMarks / studentMarks.length;
                    
                    studentResults.push({
                        student,
                        totalMarks,
                        totalPoints,
                        average: parseFloat(average.toFixed(1)),
                        subjectCount: studentMarks.length,
                        generalGrade: calculateGrade(average)
                    });
                }
            });

            // Sort by total points for ranking
            studentResults.sort((a, b) => b.totalPoints - a.totalPoints);

            // Gender Breakdown
            const genderData = { male: {}, female: {} };
            ['EE', 'ME', 'AE', 'BE'].forEach(pl => {
                genderData.male[pl] = 0;
                genderData.female[pl] = 0;
            });

            studentResults.forEach(result => {
                const gender = result.student.gender.toLowerCase();
                if (genderData[gender]) {
                    genderData[gender][result.generalGrade.pl]++;
                }
            });

            // Subject Analysis
            const subjectAnalysis = {};
            appData.settings.subjects.forEach(subject => {
                const subjectMarks = marks.filter(m => m.subject === subject.name);
                if (subjectMarks.length > 0) {
                    const markValues = subjectMarks.map(m => m.mark);
                    subjectAnalysis[subject.name] = {
                        code: subject.code,
                        average: (markValues.reduce((sum, m) => sum + m, 0) / markValues.length).toFixed(1),
                        highest: Math.max(...markValues),
                        lowest: Math.min(...markValues),
                        students: markValues.length,
                        passRate: ((markValues.filter(m => m >= 50).length / markValues.length) * 100).toFixed(1)
                    };
                }
            });

            // Display Results
            document.getElementById('subjectChampions').innerHTML = Object.entries(subjectChampions)
                .map(([subject, data]) => `
                    <div class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900 rounded-lg">
                        <div>
                            <span class="champion-badge">${data.code}</span>
                            <span class="font-semibold ml-2">${data.students.join(', ')}</span>
                        </div>
                        <span class="font-bold text-lg text-yellow-700 dark:text-yellow-300">${data.mark}%</span>
                    </div>
                `).join('');

            document.getElementById('overallStats').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center p-3 bg-blue-50 dark:bg-blue-900 rounded">
                        <p class="text-sm text-blue-600 dark:text-blue-300">Total Students</p>
                        <p class="text-2xl font-bold text-blue-800 dark:text-blue-200">${stats.totalStudents}</p>
                    </div>
                    <div class="text-center p-3 bg-green-50 dark:bg-green-900 rounded">
                        <p class="text-sm text-green-600 dark:text-green-300">Mark Entries</p>
                        <p class="text-2xl font-bold text-green-800 dark:text-green-200">${stats.totalMarksEntries}</p>
                    </div>
                    <div class="text-center p-3 bg-purple-50 dark:bg-purple-900 rounded">
                        <p class="text-sm text-purple-600 dark:text-purple-300">Class Average</p>
                        <p class="text-2xl font-bold text-purple-800 dark:text-purple-200">${stats.averageMark}%</p>
                    </div>
                    <div class="text-center p-3 bg-red-50 dark:bg-red-900 rounded">
                        <p class="text-sm text-red-600 dark:text-red-300">Pass Rate</p>
                        <p class="text-2xl font-bold text-red-800 dark:text-red-200">${stats.passRate}%</p>
                    </div>
                </div>
                
                <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                    <div class="flex justify-between">
                        <span>Highest Mark:</span>
                        <strong class="text-green-600">${stats.highestMark}%</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Lowest Mark:</span>
                        <strong class="text-red-600">${stats.lowestMark}%</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Average Points:</span>
                        <strong class="text-blue-600">${stats.averagePoints}</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>Subjects Covered:</span>
                        <strong class="text-purple-600">${Object.keys(subjectAnalysis).length}</strong>
                    </div>
                </div>
            `;

            document.getElementById('genderBreakdown').innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Gender</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">EE</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">ME</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">AE</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">BE</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Total</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Excellence Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded text-sm">Male</span>
                                </td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-ee">${genderData.male.EE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-me">${genderData.male.ME}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-ae">${genderData.male.AE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-be">${genderData.male.BE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">${Object.values(genderData.male).reduce((a, b) => a + b, 0)}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">
                                    ${Object.values(genderData.male).reduce((a, b) => a + b, 0) > 0 ? 
                                        ((genderData.male.EE / Object.values(genderData.male).reduce((a, b) => a + b, 0)) * 100).toFixed(1) : 0}%
                                </td>
                            </tr>
                            <tr>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">
                                    <span class="px-2 py-1 bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200 rounded text-sm">Female</span>
                                </td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-ee">${genderData.female.EE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-me">${genderData.female.ME}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-ae">${genderData.female.AE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold grade-be">${genderData.female.BE}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">${Object.values(genderData.female).reduce((a, b) => a + b, 0)}</td>
                                <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">
                                    ${Object.values(genderData.female).reduce((a, b) => a + b, 0) > 0 ? 
                                        ((genderData.female.EE / Object.values(genderData.female).reduce((a, b) => a + b, 0)) * 100).toFixed(1) : 0}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('subjectAnalysis').innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Subject</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Students</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Average</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Highest</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Lowest</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Pass Rate</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(subjectAnalysis).map(([subject, data]) => {
                                const performance = parseFloat(data.average) >= 75 ? 'Excellent' : 
                                                  parseFloat(data.average) >= 60 ? 'Good' : 
                                                  parseFloat(data.average) >= 50 ? 'Average' : 'Needs Improvement';
                                const performanceClass = parseFloat(data.average) >= 75 ? 'text-green-600' : 
                                                       parseFloat(data.average) >= 60 ? 'text-blue-600' : 
                                                       parseFloat(data.average) >= 50 ? 'text-yellow-600' : 'text-red-600';
                                return `
                                    <tr>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3">
                                            <div class="font-semibold">${subject}</div>
                                            <div class="text-sm text-gray-500">${data.code}</div>
                                        </td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">${data.students}</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">${data.average}%</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center text-green-600 font-semibold">${data.highest}%</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center text-red-600 font-semibold">${data.lowest}%</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-semibold">${data.passRate}%</td>
                                        <td class="border border-gray-300 dark:border-gray-600 p-3 text-center ${performanceClass} font-semibold">${performance}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // Top 10 Performers
            const top10 = studentResults.slice(0, 10);
            document.getElementById('topPerformers').innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Rank</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Name</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Assessment No</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Gender</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Total Points</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Average</th>
                                <th class="border border-gray-300 dark:border-gray-600 p-3">Grade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top10.map((result, index) => `
                                <tr class="${index < 3 ? 'bg-yellow-50 dark:bg-yellow-900' : ''}">
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">
                                        <span class="font-bold text-lg ${index === 0 ? 'text-yellow-600' : index === 1 ? 'text-gray-600' : index === 2 ? 'text-orange-600' : 'text-primary'}">
                                            ${index + 1}${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : ''}
                                        </span>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${result.student.name}</td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 font-mono text-sm">${result.student.assessmentNumber}</td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3">
                                        <span class="px-2 py-1 rounded text-xs ${result.student.gender === 'Male' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200'}">
                                            ${result.student.gender}
                                        </span>
                                    </td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold text-primary">${result.totalPoints}</td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">${result.average}%</td>
                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">
                                        <span class="px-2 py-1 rounded text-sm font-bold ${result.generalGrade.class}">${result.generalGrade.pl}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
        }

        function showAnnouncements() {
            const contentArea = document.getElementById('contentArea');
            const isAdmin = currentUser.role === 'admin';
            
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üì¢ Announcements</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Total: ${appData.announcements.length} announcements</span>
                            </div>
                        </div>
                        
                        ${isAdmin ? `
                            <!-- Create Announcement Form -->
                            <div class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 p-6 rounded-lg">
                                <h3 class="text-lg font-semibold mb-4 text-yellow-700 dark:text-yellow-300">‚ûï Create New Announcement</h3>
                                <form id="announcementForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Title <span class="text-red-500">*</span></label>
                                        <input type="text" id="announcementTitle" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter announcement title">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Message <span class="text-red-500">*</span></label>
                                        <textarea id="announcementMessage" rows="4" class="w-full p-3 border rounded-lg text-base" required placeholder="Enter announcement message"></textarea>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Target Audience <span class="text-red-500">*</span></label>
                                            <select id="announcementAudience" class="w-full p-3 border rounded-lg text-base" required>
                                                <option value="all">All Users</option>
                                                <option value="teachers">Teachers Only</option>
                                                <option value="parents">Parents Only</option>
                                                <option value="students">Students Only</option>
                                                <option value="admin">Administrators Only</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Priority Level</label>
                                            <select id="announcementPriority" class="w-full p-3 border rounded-lg text-base">
                                                <option value="normal">Normal</option>
                                                <option value="high">High Priority</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition font-semibold">
                                        üì¢ Post Announcement
                                    </button>
                                </form>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Announcements List -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">üìã Recent Announcements</h3>
                            <div class="flex space-x-2">
                                <select id="audienceFilter" class="p-2 border rounded text-sm" onchange="filterAnnouncements()">
                                    <option value="">All Audiences</option>
                                    <option value="all">All Users</option>
                                    <option value="teachers">Teachers</option>
                                    <option value="parents">Parents</option>
                                    <option value="students">Students</option>
                                    <option value="admin">Administrators</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="announcementsList" class="space-y-4">
                            ${appData.announcements.length === 0 ? 
                                '<div class="text-center py-12"><div class="text-6xl mb-4">üì¢</div><p class="text-gray-500 dark:text-gray-400 text-lg">No announcements yet</p><p class="text-gray-400 dark:text-gray-500 text-sm">Announcements will appear here when posted</p></div>' :
                                appData.announcements.map(announcement => {
                                    const priorityColors = {
                                        normal: 'border-blue-200 dark:border-blue-700 bg-blue-50 dark:bg-blue-900',
                                        high: 'border-orange-200 dark:border-orange-700 bg-orange-50 dark:bg-orange-900',
                                        urgent: 'border-red-200 dark:border-red-700 bg-red-50 dark:bg-red-900'
                                    };
                                    const priorityIcons = {
                                        normal: 'üì¢',
                                        high: '‚ö†Ô∏è',
                                        urgent: 'üö®'
                                    };
                                    
                                    return `
                                        <div class="border rounded-lg p-4 ${priorityColors[announcement.priority || 'normal']}">
                                            <div class="flex justify-between items-start mb-3">
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-2xl">${priorityIcons[announcement.priority || 'normal']}</span>
                                                    <h4 class="font-bold text-lg">${announcement.title}</h4>
                                                    ${announcement.priority === 'urgent' ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold animate-pulse">URGENT</span>' : ''}
                                                    ${announcement.priority === 'high' ? '<span class="bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold">HIGH PRIORITY</span>' : ''}
                                                </div>
                                                <div class="text-right text-sm">
                                                    <div class="text-gray-600 dark:text-gray-400">${new Date(announcement.date).toLocaleDateString()}</div>
                                                    <div class="text-xs">
                                                        <span class="px-2 py-1 bg-primary text-white rounded">${announcement.audience}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <p class="text-gray-700 dark:text-gray-300 mb-3 leading-relaxed">${announcement.message}</p>
                                            <div class="flex justify-between items-center">
                                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                                    Posted by: <strong>${announcement.postedBy}</strong> ‚Ä¢ ${new Date(announcement.date).toLocaleString()}
                                                </div>
                                                ${isAdmin ? `
                                                    <div class="flex space-x-2">
                                                        <button onclick="deleteAnnouncement('${announcement.id}')" 
                                                                class="text-red-500 hover:text-red-700 text-sm px-3 py-1 border border-red-300 rounded hover:bg-red-50 transition">
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                    </div>
                </div>
            `;

            if (isAdmin) {
                document.getElementById('announcementForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    const title = document.getElementById('announcementTitle').value.trim();
                    const message = document.getElementById('announcementMessage').value.trim();
                    const audience = document.getElementById('announcementAudience').value;
                    const priority = document.getElementById('announcementPriority').value;

                    if (!title || !message) {
                        alert('‚ö†Ô∏è Please fill in all required fields.');
                        return;
                    }

                    const announcement = {
                        id: Date.now().toString(),
                        title,
                        message,
                        audience,
                        priority,
                        date: new Date().toISOString(),
                        postedBy: currentUser.username
                    };

                    appData.announcements.unshift(announcement);
                    saveData();
                    alert('‚úÖ Announcement posted successfully!');
                    showAnnouncements(); // Refresh the view
                });
            }
        }

        function deleteAnnouncement(id) {
            if (confirm('üóëÔ∏è Are you sure you want to delete this announcement?\n\nThis action cannot be undone.')) {
                const index = appData.announcements.findIndex(a => a.id === id);
                if (index > -1) {
                    appData.announcements.splice(index, 1);
                    saveData();
                    showAnnouncements(); // Refresh the view
                    alert('‚úÖ Announcement deleted successfully!');
                }
            }
        }

        function filterAnnouncements() {
            const audience = document.getElementById('audienceFilter').value;
            const announcementsList = document.getElementById('announcementsList');
            
            let filteredAnnouncements = appData.announcements;
            if (audience) {
                filteredAnnouncements = appData.announcements.filter(a => a.audience === audience);
            }

            if (filteredAnnouncements.length === 0) {
                announcementsList.innerHTML = '<div class="text-center py-12"><div class="text-6xl mb-4">üì¢</div><p class="text-gray-500 dark:text-gray-400 text-lg">No announcements found</p><p class="text-gray-400 dark:text-gray-500 text-sm">Try selecting a different audience filter</p></div>';
                return;
            }

            const isAdmin = currentUser.role === 'admin';
            announcementsList.innerHTML = filteredAnnouncements.map(announcement => {
                const priorityColors = {
                    normal: 'border-blue-200 dark:border-blue-700 bg-blue-50 dark:bg-blue-900',
                    high: 'border-orange-200 dark:border-orange-700 bg-orange-50 dark:bg-orange-900',
                    urgent: 'border-red-200 dark:border-red-700 bg-red-50 dark:bg-red-900'
                };
                const priorityIcons = {
                    normal: 'üì¢',
                    high: '‚ö†Ô∏è',
                    urgent: 'üö®'
                };
                
                return `
                    <div class="border rounded-lg p-4 ${priorityColors[announcement.priority || 'normal']}">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">${priorityIcons[announcement.priority || 'normal']}</span>
                                <h4 class="font-bold text-lg">${announcement.title}</h4>
                                ${announcement.priority === 'urgent' ? '<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold animate-pulse">URGENT</span>' : ''}
                                ${announcement.priority === 'high' ? '<span class="bg-orange-500 text-white px-2 py-1 rounded text-xs font-bold">HIGH PRIORITY</span>' : ''}
                            </div>
                            <div class="text-right text-sm">
                                <div class="text-gray-600 dark:text-gray-400">${new Date(announcement.date).toLocaleDateString()}</div>
                                <div class="text-xs">
                                    <span class="px-2 py-1 bg-primary text-white rounded">${announcement.audience}</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mb-3 leading-relaxed">${announcement.message}</p>
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                Posted by: <strong>${announcement.postedBy}</strong> ‚Ä¢ ${new Date(announcement.date).toLocaleString()}
                            </div>
                            ${isAdmin ? `
                                <div class="flex space-x-2">
                                    <button onclick="deleteAnnouncement('${announcement.id}')" 
                                            class="text-red-500 hover:text-red-700 text-sm px-3 py-1 border border-red-300 rounded hover:bg-red-50 transition">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showSettings() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">‚öôÔ∏è System Settings</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Administrator Panel</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settings Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Academic Settings -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-blue-600">üìÖ Academic Year Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Current Academic Year</label>
                                    <select id="currentYear" class="w-full p-3 border rounded-lg text-base">
                                        ${Array.from({length: 26}, (_, i) => 2025 + i).map(year => 
                                            `<option value="${year}" ${year === appData.settings.currentYear ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <button onclick="updateCurrentYear()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition w-full font-semibold">
                                    üíæ Update Academic Year
                                </button>
                            </div>
                        </div>
                        
                        <!-- System Information -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-green-600">üìä System Information</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded text-center">
                                        <div class="text-2xl font-bold text-blue-600">${appData.students.length}</div>
                                        <div class="text-sm text-blue-600">Students</div>
                                    </div>
                                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded text-center">
                                        <div class="text-2xl font-bold text-green-600">${appData.teachers.length}</div>
                                        <div class="text-sm text-green-600">Teachers</div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-purple-50 dark:bg-purple-900 p-3 rounded text-center">
                                        <div class="text-2xl font-bold text-purple-600">${appData.marks.length}</div>
                                        <div class="text-sm text-purple-600">Mark Entries</div>
                                    </div>
                                    <div class="bg-orange-50 dark:bg-orange-900 p-3 rounded text-center">
                                        <div class="text-2xl font-bold text-orange-600">${appData.announcements.length}</div>
                                        <div class="text-sm text-orange-600">Announcements</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Term Dates & Data Management -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Term Dates -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-orange-600">üìÜ Term Dates Configuration</h3>
                            <div class="space-y-4">
                                ${appData.settings.terms.map((term, index) => `
                                    <div class="border dark:border-gray-600 p-3 rounded">
                                        <h4 class="font-semibold mb-2">${term.name}</h4>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="block text-xs text-gray-600 dark:text-gray-400">Opening Date</label>
                                                <input type="date" id="term${index}Opening" class="w-full p-2 border rounded text-sm">
                                            </div>
                                            <div>
                                                <label class="block text-xs text-gray-600 dark:text-gray-400">Closing Date</label>
                                                <input type="date" id="term${index}Closing" class="w-full p-2 border rounded text-sm">
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                                <button onclick="updateTermDates()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition w-full font-semibold">
                                    üíæ Update Term Dates
                                </button>
                            </div>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-red-600">üíæ Data Management</h3>
                            <div class="space-y-3">
                                <button onclick="exportData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition w-full font-semibold">
                                    üì• Export All Data
                                </button>
                                <button onclick="importData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition w-full font-semibold">
                                    üì§ Import Data
                                </button>
                                <button onclick="backupData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition w-full font-semibold">
                                    üíæ Create Backup
                                </button>
                                <div class="border-t dark:border-gray-600 pt-3">
                                    <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition w-full font-semibold">
                                        üóëÔ∏è Clear All Data
                                    </button>
                                    <p class="text-xs text-red-500 mt-1 text-center">‚ö†Ô∏è This action cannot be undone</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- School Information & Grading System -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- School Information -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-primary">üè´ School Information</h3>
                            <div class="space-y-3 text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">School Name</h4>
                                        <p>Rama SDA Junior School</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Address</h4>
                                        <p>P.O. BOX 45-50201, CHEPTAIS</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Motto</h4>
                                        <p class="italic">"IN GOD WE CAN"</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded">
                                        <h4 class="font-semibold text-primary">Curriculum</h4>
                                        <p>CBC (Competency Based)</p>
                                    </div>
                                </div>
                                <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded border border-blue-200 dark:border-blue-700">
                                    <h4 class="font-semibold text-blue-700 dark:text-blue-300">Grades & Subjects</h4>
                                    <p class="text-blue-600 dark:text-blue-400">Grades: ${appData.settings.grades.join(', ')}</p>
                                    <p class="text-blue-600 dark:text-blue-400">Learning Areas: ${appData.settings.subjects.length} subjects</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Grading System -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-indigo-600">üìä Grading System Reference</h3>
                            <div class="space-y-4 text-sm">
                                <div>
                                    <h4 class="font-semibold mb-2">Performance Levels</h4>
                                    <div class="space-y-1">
                                        <div class="flex justify-between items-center p-2 grade-ee rounded">
                                            <span>EE - Exceeding Expectations</span>
                                            <span class="font-bold">75-100%</span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 grade-me rounded">
                                            <span>ME - Meeting Expectations</span>
                                            <span class="font-bold">50-74%</span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 grade-ae rounded">
                                            <span>AE - Approaching Expectations</span>
                                            <span class="font-bold">25-49%</span>
                                        </div>
                                        <div class="flex justify-between items-center p-2 grade-be rounded">
                                            <span>BE - Below Expectations</span>
                                            <span class="font-bold">0-24%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2">Achievement Levels</h4>
                                    <div class="grid grid-cols-2 gap-1 text-xs">
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL8</span><span>88-100 (8pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL7</span><span>75-87 (7pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL6</span><span>62-74 (6pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL5</span><span>50-61 (5pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL4</span><span>37-49 (4pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL3</span><span>25-36 (3pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL2</span><span>12-24 (2pts)</span>
                                        </div>
                                        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded">
                                            <span>AL1</span><span>0-11 (1pt)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateCurrentYear() {
            const year = parseInt(document.getElementById('currentYear').value);
            appData.settings.currentYear = year;
            saveData();
            alert(`‚úÖ Academic year updated to ${year} successfully!`);
        }

        function updateTermDates() {
            // Update term dates logic here
            alert('‚úÖ Term dates updated successfully!');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rama_sda_school_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Data exported successfully!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (confirm('‚ö†Ô∏è This will replace all current data. Are you sure you want to continue?')) {
                                appData = importedData;
                                saveData();
                                alert('‚úÖ Data imported successfully!');
                                showDashboard();
                            }
                        } catch (error) {
                            alert('‚ùå Invalid file format. Please select a valid JSON file exported from this system.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function backupData() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rama_sda_backup_${timestamp}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('‚úÖ Backup created successfully!');
        }

        function clearAllData() {
            if (confirm('üóëÔ∏è This will permanently delete ALL data including:\n\n‚Ä¢ All students\n‚Ä¢ All teachers\n‚Ä¢ All marks\n‚Ä¢ All announcements\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?') && 
                confirm('‚ö†Ô∏è FINAL WARNING: This will erase everything!\n\nType "DELETE" in the next prompt to confirm.')) {
                const confirmation = prompt('Type "DELETE" to confirm data deletion:');
                if (confirmation === 'DELETE') {
                    appData = {
                        students: [],
                        teachers: [],
                        marks: [],
                        announcements: [],
                        settings: appData.settings // Keep settings
                    };
                    saveData();
                    alert('‚úÖ All data has been cleared.');
                    showDashboard();
                } else {
                    alert('‚ùå Deletion cancelled - incorrect confirmation.');
                }
            }
        }

        function showParentResults() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-primary">üìÑ Student Results</h2>
                            <div class="flex items-center space-x-2">
                                <div class="logo-container small-logo"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">Parent Portal</span>
                            </div>
                        </div>
                        
                        <!-- Student Selection -->
                        <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-4 text-green-700 dark:text-green-300">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Select Your Child</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Student</label>
                                    <select id="parentStudentSelect" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Student</option>
                                        ${appData.students.map(student => 
                                            `<option value="${student.assessmentNumber}">${student.name} (${student.assessmentNumber}) - Grade ${student.grade}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Quick Info</label>
                                    <div id="studentQuickInfo" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm">
                                        Select a student to view information
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Display -->
                    <div id="parentResultsDisplay" class="hidden">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-4 text-blue-600">üìä View Results</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Academic Year</label>
                                    <select id="parentYear" class="w-full p-3 border rounded-lg text-base">
                                        ${Array.from({length: 26}, (_, i) => 2025 + i).map(year => 
                                            `<option value="${year}" ${year === appData.settings.currentYear ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Term</label>
                                    <select id="parentTerm" class="w-full p-3 border rounded-lg text-base">
                                        <option value="">Select Term</option>
                                        ${appData.settings.terms.map(term => `<option value="${term.name}">${term.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="viewResultsBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-opacity-90 transition w-full font-semibold">
                                        üîç View Results
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="studentResultsTable"></div>
                    </div>
                </div>
            `;

            document.getElementById('parentStudentSelect').addEventListener('change', function(e) {
                const studentId = e.target.value;
                const quickInfo = document.getElementById('studentQuickInfo');
                
                if (studentId) {
                    const student = appData.students.find(s => s.assessmentNumber === studentId);
                    const studentMarks = appData.marks.filter(m => m.studentId === studentId);
                    
                    quickInfo.innerHTML = `
                        <div class="grid grid-cols-2 gap-2">
                            <div><strong>Name:</strong> ${student.name}</div>
                            <div><strong>Grade:</strong> ${student.grade}</div>
                            <div><strong>Gender:</strong> ${student.gender}</div>
                            <div><strong>Total Marks:</strong> ${studentMarks.length}</div>
                        </div>
                    `;
                    document.getElementById('parentResultsDisplay').classList.remove('hidden');
                } else {
                    quickInfo.innerHTML = 'Select a student to view information';
                    document.getElementById('parentResultsDisplay').classList.add('hidden');
                }
            });

            document.getElementById('viewResultsBtn').addEventListener('click', function() {
                const studentId = document.getElementById('parentStudentSelect').value;
                const year = document.getElementById('parentYear').value;
                const term = document.getElementById('parentTerm').value;

                if (!studentId || !term) {
                    alert('‚ö†Ô∏è Please select student and term.');
                    return;
                }

                const student = appData.students.find(s => s.assessmentNumber === studentId);
                const studentMarks = appData.marks.filter(m => 
                    m.studentId === studentId &&
                    m.year == year &&
                    m.term === term
                );

                let totalMarks = 0;
                let totalPoints = 0;
                let subjectCount = 0;

                const resultsHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="text-center mb-6">
                            <div class="flex justify-center items-center mb-4">
                                <div class="logo-container small-logo mr-3"></div>
                                <div>
                                    <h3 class="text-xl font-bold text-primary">RAMA SDA JUNIOR SCHOOL</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">"IN GOD WE CAN"</p>
                                </div>
                            </div>
                            <h3 class="text-lg font-semibold">üìã Results for ${student.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 text-sm">
                                <div><strong>Assessment Number:</strong> ${student.assessmentNumber}</div>
                                <div><strong>Grade:</strong> ${student.grade}</div>
                                <div><strong>Term:</strong> ${term} ${year}</div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-gray-100 dark:bg-gray-700">
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Learning Area</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Code</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Mark (%)</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Performance Level</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Achievement Level</th>
                                        <th class="border border-gray-300 dark:border-gray-600 p-3">Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appData.settings.subjects.map(subject => {
                                        const mark = studentMarks.find(m => m.subject === subject.name);
                                        if (mark) {
                                            totalMarks += mark.mark;
                                            totalPoints += mark.points;
                                            subjectCount++;
                                            const gradeInfo = calculateGrade(mark.mark);
                                            return `
                                                <tr>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${subject.name}</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-mono">${subject.code}</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold text-lg">${mark.mark}%</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">
                                                        <span class="px-3 py-1 rounded font-bold ${gradeInfo.class}">${mark.pl}</span>
                                                    </td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold">${mark.al}</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-bold text-primary">${mark.points}</td>
                                                </tr>
                                            `;
                                        } else {
                                            return `
                                                <tr>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 font-semibold">${subject.name}</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center font-mono">${subject.code}</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center text-gray-500">Not assessed</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">-</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">-</td>
                                                    <td class="border border-gray-300 dark:border-gray-600 p-3 text-center">-</td>
                                                </tr>
                                            `;
                                        }
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        ${subjectCount > 0 ? `
                            <div class="mt-8">
                                <h4 class="text-lg font-semibold mb-4 text-center">üìä Performance Summary</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg text-center">
                                        <p class="text-sm text-blue-600 dark:text-blue-300 font-medium">Total Marks</p>
                                        <p class="text-2xl font-bold text-blue-800 dark:text-blue-200">${totalMarks}</p>
                                    </div>
                                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg text-center">
                                        <p class="text-sm text-green-600 dark:text-green-300 font-medium">Average</p>
                                        <p class="text-2xl font-bold text-green-800 dark:text-green-200">${(totalMarks / subjectCount).toFixed(1)}%</p>
                                    </div>
                                    <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg text-center">
                                        <p class="text-sm text-purple-600 dark:text-purple-300 font-medium">Total Points</p>
                                        <p class="text-2xl font-bold text-purple-800 dark:text-purple-200">${totalPoints}/72</p>
                                    </div>
                                    <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg text-center">
                                        <p class="text-sm text-orange-600 dark:text-orange-300 font-medium">General Grade</p>
                                        <p class="text-2xl font-bold text-orange-800 dark:text-orange-200">${calculateGrade(totalMarks / subjectCount).pl}</p>
                                    </div>
                                </div>
                                
                                <div class="mt-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                    <h5 class="font-semibold mb-2">üìà Performance Analysis</h5>
                                    <div class="text-sm space-y-1">
                                        <p><strong>General Performance Level:</strong> ${getPerformanceLevelFull(calculateGrade(totalMarks / subjectCount).pl)}</p>
                                        <p><strong>Subjects Assessed:</strong> ${subjectCount} out of ${appData.settings.subjects.length}</p>
                                        <p><strong>Points Percentage:</strong> ${((totalPoints / 72) * 100).toFixed(1)}% of maximum possible</p>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="mt-8 text-center py-8">
                                <div class="text-6xl mb-4">üìö</div>
                                <p class="text-gray-500 text-lg">No results available for this term</p>
                                <p class="text-gray-400 text-sm">Results will appear here when marks are entered</p>
                            </div>
                        `}
                    </div>
                `;

                document.getElementById('studentResultsTable').innerHTML = resultsHTML;
            });
        }

        // Initialize the application
        loadData();
        updateTime();
        showDashboard();
    </script>
</body>
</html>
